---
title: "Initial data analysis"
author: "Sara Salimi"
date: "11/04/2019"
output:
  html_document:
    toc: true
    toc_depth: 3
    toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, message=FALSE, warning=FALSE, paged.print=TRUE)
```

## Objective

The purpose of this lab is to do some basic data cleaning and highlight major questions that are to be addressed by the data analysis project.  

## Topic: 
Is there a relationship between poverty levels and opioid deaths in counties across the United States? 

## Questions I want to address: answers below 
- What are the poverty rates in counties across the US?
- What is the median household income in these counties?
- What percentage of people in the counties live below the poverty line?
- What are the education levels of these populations?
- Which race(s) are being targeted most in opioid shipments?
- Which pharmacies are located in areas with high poverty levels?
- How many shipments did these pharmacies receive?
- What are the death rates in counties across the US?
- What are the death rates from opioid overdoses in these counties?
- How many pills per person in each of these counties?
- How did the number of pills per person change between 2006-2012?
- Were the pharmaceutical companies in these areas faced with any lawsuits?
- In places where people are poor, are there more pills per population?
- In places where people are poor, are there more deaths?
- In places where people are poor, are there more pills shipments and deaths?
- In places that are predominantly black, are there more pill shipments?
- In places that are predominantly black, are there more opioid deaths?
- Is there a correlation between gender and opioid overdose?
- Is the relationship uniform or are there specific trends within individual states/counties?
- Is there a "model" state that exemplifies the relationship between poverty and opioid deaths?
- Is there a "model" state that exemplifies the relationship between gender and opioid deaths?
- Is there a "model" state that exemplifies the relationship between income and opioid deaths?
- Is there a "model" state that exemplifies the relationship between race and opioid deaths?
- Is there a "model" state that exemplifies the relationship between education and opioid deaths?
- Do individual county officials have anything to say about the factors playing into the opioid trends in that given area?
- Is there a specific factor that a significant level of the opioid data could be attributed to?
- What are the different correlation coefficients for the factors I'm looking into?
- How can we visualize changes in pills per person, deaths per county, and poverty levels?
- How do we make sure the data visualization is accurate and the graphs are trustable?


```{r}

# Loading the packages we will work with throughout the project
library(tidyverse)
library(janitor)
library(arcos)
library(tidycensus)
library(scales)
library(ggthemes)
library(mapview)
library(corrr)

census_api_key("549950d36c22ff16455fe196bbbd01d63cfbe6cf")

```


```{r}
# store one of our API keys as an object called key
key <- "uO4EK6I"
```

We will start by getting the total pills and shipments for each county in the U.S. per year.  

We will store them as an object called "arcos_county_pills_per_year".  We're going to use a function called "summarized_county_annual" and we're going to set the key as equal to the key we just stored. We will also use the clean_names function to make our data easier to visually examine. 

```{r}
arcos_county_pills_per_year <- summarized_county_annual(key = key) %>%
  clean_names()
```


We will also add the county population with estimates for each year between 2006-2012 to our data and use the clean_names function again for better clarity:

```{r}
arcos_county_population_per_year <- county_population(key = key) %>%
  clean_names()

```

There seems to be an inconsistent number of records for the pills and population datasets. There are some counties that are not in the pills table, and some pill shipments not in the county populations table. We will use the antijoin function to see what they are: 


```{r}
# 999 records in our population table without a countyfips+year match in our pills table
not_in_pills <- arcos_county_population_per_year %>%
  anti_join(arcos_county_pills_per_year, by=c("countyfips","year"))

# 595 records in our pills table without a countyfips+year match in population table.  
not_in_population <- arcos_county_pills_per_year %>%
  anti_join(arcos_county_population_per_year, by=c("countyfips","year"))
```

Now we want to put these two datasets (pills and population) together. We will join them on both countyfips and year. We will also take out buyer_county and buyer_state because they're in both tables. 


```{r}
pills_population <- arcos_county_population_per_year %>%
  left_join(arcos_county_pills_per_year, by = c("countyfips", "year", "buyer_county","buyer_state"))
```

For future purposes involving mapping and data visualization, we will clean up our data to better work with the state codes. We will make a column at the very beginning of the table called statefips, which will only have 


```{r}
pills_population <- pills_population %>%
   mutate(statefips = str_sub(countyfips, 1,2)) %>%
   select(statefips, countyfips, buyer_county, buyer_state,year, population,dosage_unit)

```

Now that our tables are joined, we are going to do our pills per population calculation. We will call the new column avg_yearly_pills_per_person and divide pills by population to get the value. We will also rank in descending order to see which counties are receiving the highest number of pills per person: 

```{r}
pills_population <- pills_population %>%
  mutate(pills_per_person = dosage_unit/population) %>%
  select(statefips, countyfips, buyer_county, buyer_state, year, dosage_unit, population, pills_per_person) %>%
  arrange(desc(pills_per_person))

# From this initial data analysis, we can see that the highest number of pills per person are in Leavenworth, Kansas between 2006-2008. Since there are so many counties we are looking at, we will proceed to do some filtering to get a better sense of what's going on. 

```

For a start, we will filter for Montgomery County, Maryland. 

```{r}
mont_county <- pills_population %>%
  filter(buyer_county == "MONTGOMERY", buyer_state == "MD") %>%
  arrange(desc(pills_per_person))

#From this selection, we see that the average pills per person in this county was at almost 17 pills per person, a number that increased from 12 pills in 2006. 
```

To visualize our data, we will add a bar graph that can help with better seeing this slight increase in the number of pills per person between 2006-2012:

```{r}
ggplot(mont_county) +
  geom_bar(stat="identity", aes(year, pills_per_person), fill="royal blue") +
  labs(x="Year", y="Pills per person", title="In Montgomery County, the number of pills per person slightly increased between 2006-2012.", caption = "Source: DEA ARCOS database, via Washington Post") +
  scale_x_continuous(breaks = c(2006, 2007, 2008, 2009, 2010, 2011, 2012)) +
  scale_y_continuous(labels = comma)

#This graph helps see the trends much more clearly. Although Montgomery County doesn't seem to have a drastic change in the number of pills per person, other counties might have a more noticeable change. For the rest of the data analysis, I will sample a few other counties and then add in the poverty data to further analyze. 

```

We will now add in data from Tidycensus:  

```{r}

county_geodata <- get_acs(geography = "county",
              variables = "B01001_001", geometry = TRUE)

state_geodata <- get_acs(geography = "state",
              variables = "B01001_001", geometry = TRUE)

```

We will now pull out data from the American Community Survey on median household income between 2008-2012:

```{r}
#Pulling out median household income by state:
state_median_income <- get_acs(geography = "state", variables = "B19013_001", endyear = 2012) %>%
  arrange(desc(estimate))

#Here we see that Maryland had the highest median household income between 2008-2012, and Puerto Rico had the lowest. 
              
```

```{r}
#Pulling out median household income by county:
county_median_income <- get_acs(geography = "county", variables = "B19013_001", endyear = 2012) %>%
  arrange(desc(estimate))

# Here we see that Falls Church City, Virginia had the highest median household income, and Lares Municipio, Puerto Rico had the lowest. 
            
```

Since we now have both sets of data (pills per person and median household income), we will do an inner join. First, we will change "GEOID" to countyfips so that we can do the join: 

```{r}
colnames(county_median_income)[colnames(county_median_income)=="GEOID"] <- "countyfips"
```

```{r}
#doing the inner join: 
pills_population_x <- county_median_income %>%
  inner_join(pills_population, by="countyfips") %>%
  group_by(buyer_county, buyer_state, countyfips) %>%
  summarise(median_income = mean(estimate),
            avg_pills_person = mean(pills_per_person))

```

Let's plot to see how this looks on a graph: 

```{r}
pills_population_x %>%
  filter(avg_pills_person < 200) %>%
  ggplot() +
  geom_point(aes(median_income, avg_pills_person)) + 
  geom_smooth(aes(median_income, avg_pills_person), method="lm")

```

```{r}

pills_population_x %>%
  ungroup() %>%
  select(median_income, avg_pills_person) %>%
  correlate()

```

```{r}
ggplot(pills_population) +
  geom_point(aes(population, pills_per_person)) +
  labs(x="Median household income", y="Pills per person", title="Pills per person by county median household income in the United States", caption = "Source: DEA ARCOS database, via Washington Post", fill="buyer_county") +
  scale_y_continuous(labels = comma) +
  scale_x_continuous(labels = comma) + 
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  geom_smooth(aes(population, dosage_unit), method = "lm", se = FALSE) +
  geom_text(aes(population, pills_per_person, label=buyer_county))

```

```{r}
colnames(county_percent_men)[colnames(county_percent_men)=="GEOID"] <- "countyfips"
```

```{r}
#doing the inner join: 
pills_population_x <- county_percent_men %>%
  inner_join(pills_population, by="countyfips") %>%
  group_by(buyer_county, buyer_state, countyfips) %>%
  summarise(percent_men = mean(percent_men),
            avg_pills_person = mean(pills_per_person))

```

```{r}
pills_population_x %>%
  #filter(avg_pills_person < 200) %>%
  ggplot() +
  geom_point(aes(percent_men, avg_pills_person)) + 
  geom_smooth(aes(percent_men, avg_pills_person), method="lm")

```

```{r}

pills_population_x %>%
  ungroup() %>%
  select(percent_men, avg_pills_person) %>%
  correlate()

```


```{r}
# Examine other census variables

#acs_variables <- load_variables(2012, dataset = "acs5")

county_percent_men <- get_acs(geography = "county",
              variables = "B01001_002", summary_var = "B01001_001", geometry = FALSE) %>%
              mutate(percent_men = estimate/summary_est)

#No conclusive results.


```

Continuing the median income and opioid deaths idea... Although the correlation coefficient was not that strong, we can still come to certain conclusion by individual states. We will start off using the five states with the lowest median income (from the state median income data). We will look at trends in Puerto Rico, Mississippi, West Virginia, Arkansas, Kentucky and Alabama.  

```{r}
#Pulling out median household income data from counties in Puerto Rico: 
puerto_rico <- get_acs(geography = "county", variables = "B19013_001", survey = "acs5", 
              endyear = 2012, state = "PR") %>%
            arrange(desc(estimate))

options(scipen=999)

```

```{r}
#Plotting the data: 
puerto_rico %>%
  mutate(NAME = gsub(" County, Puerto Rico", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Household income by county in Puerto Rico",
       subtitle = "2008-2012 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")


```

```{r}
#Mississippi:

mississippi_median_income <- get_acs(geography = "county", variables = "B19013_001", survey = "acs5", 
              endyear = 2012, state = "MS") %>%
            arrange(desc(estimate))

options(scipen=999)

```


```{r}
#Plotting the data: 
mississippi_median_income %>%
  mutate(NAME = gsub(" County, Mississippi", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Household income by county in Mississippi",
       subtitle = "2008-2012 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")


```


```{r}
#West Virginia:

WV_median_income <- get_acs(geography = "county", variables = "B19013_001", survey = "acs5", 
              endyear = 2012, state = "WV") %>%
            arrange(desc(estimate))

options(scipen=999)

```


```{r}
#Plotting the data: 
WV_median_income %>%
  mutate(NAME = gsub(" County, West Virginia", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Household income by county in West Virginia",
       subtitle = "2008-2012 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")


```


```{r}
#Arkansas:

arkansas_median_income <- get_acs(geography = "county", variables = "B19013_001", survey = "acs5", 
              endyear = 2012, state = "AR") %>%
            arrange(desc(estimate))

options(scipen=999)

```


```{r}
#Plotting the data: 
arkansas_median_income %>%
  mutate(NAME = gsub(" County, Arkansas", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Household income by county in Arkansas",
       subtitle = "2008-2012 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")


```


```{r}
#Kentucky:

kentucky_median_income <- get_acs(geography = "county", variables = "B19013_001", survey = "acs5", 
              endyear = 2012, state = "KY") %>%
            arrange(desc(estimate))

options(scipen=999)

```


```{r}
#Plotting the data: 
kentucky_median_income %>%
  mutate(NAME = gsub(" County, Kentucky", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Household income by county in Kentucky",
       subtitle = "2008-2012 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")


```

```{r}
#Alabama:

alabama_median_income <- get_acs(geography = "county", variables = "B19013_001", survey = "acs5", 
              endyear = 2012, state = "AL") %>%
            arrange(desc(estimate))

options(scipen=999)

```


```{r}
#Plotting the data: 
alabama_median_income %>%
  mutate(NAME = gsub(" County, Alabama", "", NAME)) %>%
  ggplot(aes(x = estimate, y = reorder(NAME, estimate))) +
  geom_errorbarh(aes(xmin = estimate - moe, xmax = estimate + moe)) +
  geom_point(color = "red", size = 3) +
  labs(title = "Household income by county in Alabama",
       subtitle = "2008-2012 American Community Survey",
       y = "",
       x = "ACS estimate (bars represent margin of error)")


```




## Submission

Link for assignment posted in my Github: https://github.com/ssalimi-lab/data-journalism-fall2019  
